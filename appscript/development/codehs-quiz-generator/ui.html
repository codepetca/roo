<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeHS Quiz Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      padding: 25px;
    }

    .form-section {
      margin-bottom: 20px;
      padding: 18px;
      background: #f8fafc;
      border-radius: 10px;
      border-left: 4px solid #4f46e5;
    }

    .form-section h2 {
      color: #1e293b;
      margin-bottom: 15px;
      font-size: 1.25em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .unit-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      display: none;
    }

    .unit-info h4 {
      color: #1e40af;
      margin-bottom: 6px;
    }

    .unit-info p {
      color: #1e40af;
      font-size: 14px;
      line-height: 1.4;
    }

    .concept-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .concept-tag {
      background: #dbeafe;
      color: #1e40af;
      padding: 3px 7px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 500;
    }

    .generate-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 15px;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }

    .generate-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status-section {
      display: none;
      padding: 15px;
      margin-top: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .status-loading {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 10px auto;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .result-links {
      margin-top: 15px;
    }

    .result-links a {
      display: inline-block;
      margin: 4px 8px;
      padding: 8px 16px;
      background: #4f46e5;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: background 0.3s;
    }

    .result-links a:hover {
      background: #4338ca;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      width: 0%;
      transition: width 0.5s ease;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.9em;
      }

      .main-content {
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üéì CodeHS Quiz Generator</h1>
      <p>AI-Powered Programming Quiz Creation</p>
    </div>

    <div class="main-content">
      <!-- Unified Loading Section -->
      <div id="loadingSection" class="form-section" style="text-align: center; padding: 30px;">
        <div class="spinner"></div>
        <h3 id="loadingTitle">üöÄ Initializing Quiz Generator...</h3>
        <p id="loadingMessage">Checking permissions and loading curriculum...</p>
        <div class="progress-bar" style="margin-top: 20px;">
          <div id="initProgressFill" class="progress-fill" style="width: 0%;"></div>
        </div>
      </div>

      <!-- Unit Selection Section -->
      <div class="form-section" id="unitSection" style="opacity: 0.5;">
        <h2>üìö Select CodeHS Unit</h2>
        <div class="form-group">
          <select id="unitSelect" onchange="handleUnitChange()" disabled>
            <option value="">-- Loading curriculum units --</option>
          </select>
        </div>
        <div id="unitInfo" class="unit-info">
          <h4 id="unitTitle"></h4>
          <p id="unitDescription"></p>
          <div id="conceptTags" class="concept-tags"></div>
        </div>
      </div>

      <!-- Quiz Configuration Section -->
      <div class="form-section" id="configSection" style="opacity: 0.5;">
        <h2>‚öôÔ∏è Quiz Configuration</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="codingQuestions">Coding Questions:</label>
            <input type="number" id="codingQuestions" value="3" min="1" max="10" disabled>
          </div>
          <div class="form-group">
            <label for="multipleChoiceQuestions">Multiple Choice Questions:</label>
            <input type="number" id="multipleChoiceQuestions" value="20" min="5" max="50" disabled>
          </div>
        </div>
      </div>

      <!-- Customization Section -->
      <div class="form-section" id="customizationSection" style="opacity: 0.5;">
        <h2 onclick="toggleCustomization()"
          style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
          üé® Customization (Optional)
          <span id="customizationToggle" style="font-size: 0.8em;">‚ñº</span>
        </h2>
        <div id="customizationContent" style="display: none;">
          <div class="form-group">
            <label for="customTitle">Custom Quiz Title:</label>
            <input type="text" id="customTitle" placeholder="Leave blank for auto-generated title" disabled>
          </div>
          <div class="form-group">
            <label for="customDescription">Custom Description:</label>
            <textarea id="customDescription" rows="3" placeholder="Leave blank for auto-generated description"
              disabled></textarea>
          </div>
        </div>
      </div>

      <!-- Generate Button -->
      <div id="buttonsSection" style="margin-top: 20px; opacity: 0.5;">
        <button id="generateBtn" class="generate-btn" onclick="generateQuiz()" disabled>
          üöÄ Generate with AI
        </button>
      </div>

      <!-- Status Section -->
      <div id="statusSection" class="status-section">
        <div id="loadingStatus" class="status-loading" style="display: none;">
          <div class="spinner"></div>
          <h3>Generating Your Quiz...</h3>
          <p id="progressText">Initializing AI question generation...</p>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
        </div>

        <div id="successStatus" class="status-success" style="display: none;">
          <h3>‚úÖ Quiz Generated Successfully!</h3>
          <p id="successMessage"></p>
          <div class="result-links">
            <a id="viewQuizLink" href="#" target="_blank">üìù View Quiz</a>
            <a id="editQuizLink" href="#" target="_blank">‚úèÔ∏è Edit Quiz</a>
          </div>
        </div>

        <div id="errorStatus" class="status-error" style="display: none;">
          <h3>‚ùå Generation Failed</h3>
          <p id="errorMessage"></p>
          <div style="margin-top: 15px;">
            <button onclick="retryWithPermissionCheck()"
              style="padding: 10px 20px; border: none; background: #10b981; color: white; border-radius: 6px; cursor: pointer; margin-right: 10px;">üîÑ
              Smart Retry</button>
            <button onclick="resetForm()"
              style="padding: 10px 20px; border: none; background: #6b7280; color: white; border-radius: 6px; cursor: pointer;">‚Ü©Ô∏è
              Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let availableUnits = [];
    let unitDetailsCache = {};  // Cache for all unit details
    let isGenerating = false;
    let permissionStatus = null;

    // Initialize the application
    window.onload = function () {
      initializeQuizGenerator();
    };

    // Toggle customization section
    function toggleCustomization() {
      const content = document.getElementById('customizationContent');
      const toggle = document.getElementById('customizationToggle');

      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñ≤';
      } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    }

    // Unified initialization process
    function initializeQuizGenerator() {
      console.log('üöÄ Initializing CodeHS Quiz Generator...');

      // Show loading section
      document.getElementById('loadingSection').style.display = 'block';

      // Start the initialization process
      updateInitializationProgress(0, 'üîê Checking permissions...');

      // Add timeout for the entire initialization
      const initTimeoutId = setTimeout(() => {
        showInitializationError('Initialization is taking longer than expected. Please refresh the page and try again.');
      }, 30000); // 30 second timeout for entire process

      // Step 1: Check permissions
      google.script.run
        .withSuccessHandler(function (status) {
          handlePermissionResult(status, initTimeoutId);
        })
        .withFailureHandler(function (error) {
          clearTimeout(initTimeoutId);
          console.error('Permission check failed:', error);
          showInitializationError('Unable to check permissions. Please refresh and try again.');
        })
        .getPermissionStatus();
    }

    // Handle permission result and continue initialization
    function handlePermissionResult(status, timeoutId) {
      permissionStatus = status;

      if (status.ready) {
        // Permissions OK, continue with unit loading
        updateInitializationProgress(50, 'üìö Loading curriculum units...');

        google.script.run
          .withSuccessHandler(function (units) {
            clearTimeout(timeoutId);
            handleUnitsLoaded(units);
          })
          .withFailureHandler(function (error) {
            clearTimeout(timeoutId);
            console.error('Failed to load units:', error);
            showInitializationError('Failed to load curriculum units. Please refresh and try again.');
          })
          .getAllUnitsWithDetails();

      } else {
        // Permissions needed - show permission grant UI
        clearTimeout(timeoutId);
        showPermissionRequired(status);
      }
    }

    // Update initialization progress
    function updateInitializationProgress(percent, message) {
      document.getElementById('initProgressFill').style.width = percent + '%';
      document.getElementById('loadingMessage').textContent = message;
    }

    // Show permission required state
    function showPermissionRequired(status) {
      document.getElementById('loadingTitle').textContent = 'üîê Permissions Required';
      document.getElementById('loadingMessage').innerHTML =
        'This application needs additional permissions to create Google Forms and generate quizzes.<br><br>' +
        '<button onclick="requestPermissions()" style="padding: 12px 24px; border: none; background: #4f46e5; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px;">Grant Permissions</button>';
      document.getElementById('initProgressFill').style.width = '25%';
    }

    // Handle successful unit loading with details
    function handleUnitsLoaded(unitsWithDetails) {
      updateInitializationProgress(100, '‚úÖ Ready to create quizzes!');

      // Store units and cache all details for instant access
      availableUnits = unitsWithDetails.map(unit => ({
        id: unit.id,
        title: unit.title,
        description: unit.description
      }));

      // Cache all unit details for instant display
      unitsWithDetails.forEach(unit => {
        unitDetailsCache[unit.id] = unit;
      });

      console.log(`üìö Cached details for ${Object.keys(unitDetailsCache).length} units`);

      // Hide loading section with a brief success message, then enable controls
      setTimeout(() => {
        document.getElementById('loadingSection').style.display = 'none';
        // Enable all form controls after loading section disappears
        enableFormControls();
      }, 1500);
    }

    // Enable all form controls after successful initialization
    function enableFormControls() {
      // Enable unit selection
      const unitSelect = document.getElementById('unitSelect');
      unitSelect.disabled = false;
      unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
      document.getElementById('unitSection').style.opacity = '1';

      // Enable configuration inputs
      document.getElementById('codingQuestions').disabled = false;
      document.getElementById('multipleChoiceQuestions').disabled = false;
      document.getElementById('configSection').style.opacity = '1';

      // Enable customization inputs
      document.getElementById('customTitle').disabled = false;
      document.getElementById('customDescription').disabled = false;
      document.getElementById('customizationSection').style.opacity = '1';

      // Enable button section
      const buttons = document.getElementById('buttonsSection');
      buttons.style.opacity = '1';

      // Keep generate button disabled until unit is selected
      document.getElementById('generateBtn').disabled = true;

      // Populate unit dropdown
      availableUnits.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.id;
        option.textContent = unit.title;
        unitSelect.appendChild(option);
      });
    }

    // Show initialization error
    function showInitializationError(message) {
      document.getElementById('loadingTitle').textContent = '‚ùå Initialization Failed';
      document.getElementById('loadingMessage').innerHTML =
        message + '<br><br>' +
        '<button onclick="location.reload()" style="padding: 10px 20px; border: none; background: #10b981; color: white; border-radius: 6px; cursor: pointer;">üîÑ Refresh Page</button>';
      document.getElementById('initProgressFill').style.background = '#ef4444';
    }

    // Request permissions (updated for unified flow)
    function requestPermissions() {
      updateInitializationProgress(25, 'üîÑ Requesting permissions...');

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            // Restart the initialization process
            setTimeout(() => {
              initializeQuizGenerator();
            }, 1000);
          } else {
            showInitializationError(result.message || 'Failed to grant permissions. Please try again.');
          }
        })
        .withFailureHandler(function (error) {
          console.error('Permission request failed:', error);
          showInitializationError('Permission request failed. Please refresh the page and try again.');
        })
        .requestPermissions();
    }



    // Handle unit selection change (now instant with cached data)
    function handleUnitChange() {
      const selectedUnit = document.getElementById('unitSelect').value;
      const generateBtn = document.getElementById('generateBtn');

      if (selectedUnit) {
        generateBtn.disabled = false;
        // Use cached data for instant display
        const unitDetails = unitDetailsCache[selectedUnit];
        if (unitDetails) {
          displayUnitInfo(unitDetails);
        }
      } else {
        generateBtn.disabled = true;
        document.getElementById('unitInfo').style.display = 'none';
      }
    }

    // Display unit information
    function displayUnitInfo(unit) {
      document.getElementById('unitTitle').textContent = unit.title;
      document.getElementById('unitDescription').textContent = unit.description;

      const conceptTags = document.getElementById('conceptTags');
      conceptTags.innerHTML = '';

      if (unit.concepts && unit.concepts.length > 0) {
        unit.concepts.slice(0, 8).forEach(concept => { // Show first 8 concepts
          const tag = document.createElement('span');
          tag.className = 'concept-tag';
          tag.textContent = concept;
          conceptTags.appendChild(tag);
        });
      }

      document.getElementById('unitInfo').style.display = 'block';
    }

    // Generate quiz
    function generateQuiz() {
      if (isGenerating) return;

      // Check permissions before proceeding
      if (permissionStatus && !permissionStatus.ready) {
        showError('Please grant all required permissions before generating a quiz.');
        return;
      }

      const config = {
        selectedUnit: document.getElementById('unitSelect').value,
        codingQuestions: parseInt(document.getElementById('codingQuestions').value),
        multipleChoiceQuestions: parseInt(document.getElementById('multipleChoiceQuestions').value),
        customTitle: document.getElementById('customTitle').value.trim(),
        customDescription: document.getElementById('customDescription').value.trim()
      };

      // Validation
      if (!config.selectedUnit) {
        showError('Please select a CodeHS unit first.');
        return;
      }

      isGenerating = true;
      showLoadingStatus();

      google.script.run
        .withSuccessHandler(handleGenerationSuccess)
        .withFailureHandler(handleGenerationError)
        .generateQuiz(config);
    }

    // Show loading status
    function showLoadingStatus() {
      document.getElementById('statusSection').style.display = 'block';
      document.getElementById('loadingStatus').style.display = 'block';
      document.getElementById('successStatus').style.display = 'none';
      document.getElementById('errorStatus').style.display = 'none';
      document.getElementById('generateBtn').disabled = true;

      // Simulate progress
      let progress = 0;
      const progressSteps = [
        'Analyzing curriculum content...',
        'Generating questions with AI...',
        'Creating Google Form structure...',
        'Configuring quiz settings...',
        'Finalizing quiz creation...'
      ];

      const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;

        const stepIndex = Math.floor(progress / 20);
        const currentStep = progressSteps[stepIndex] || progressSteps[progressSteps.length - 1];

        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = currentStep;

        if (progress >= 90) {
          clearInterval(progressInterval);
        }
      }, 1000);

      // Store interval ID to clear it on completion
      window.progressInterval = progressInterval;
    }

    // Handle successful generation
    function handleGenerationSuccess(result) {
      isGenerating = false;
      if (window.progressInterval) clearInterval(window.progressInterval);

      if (result.success) {
        document.getElementById('loadingStatus').style.display = 'none';
        document.getElementById('successStatus').style.display = 'block';

        const message = `Created quiz with ${result.questions.coding} coding questions and ${result.questions.multipleChoice} multiple choice questions for ${result.unit}.`;
        document.getElementById('successMessage').textContent = message;

        document.getElementById('viewQuizLink').href = result.form.publishedUrl;
        document.getElementById('editQuizLink').href = result.form.editUrl;

        // Show warnings if any
        if (result.warnings && result.warnings.length > 0) {
          console.warn('Generation warnings:', result.warnings);
        }

      } else {
        handleGenerationError(result.error || 'Unknown error occurred');
      }
    }

    // Handle generation error
    function handleGenerationError(error) {
      isGenerating = false;
      if (window.progressInterval) clearInterval(window.progressInterval);

      document.getElementById('loadingStatus').style.display = 'none';
      document.getElementById('errorStatus').style.display = 'block';

      // Enhanced error handling with specific messages
      let errorMessage = '';
      let suggestion = '';

      if (error && error.message) {
        const msg = error.message.toLowerCase();

        if (msg.includes('permission') || msg.includes('auth')) {
          errorMessage = 'Permission Error: This application needs additional permissions to access Google Forms.';
          suggestion = 'Click "Try Again" to check permissions, or refresh the page to restart the authorization flow.';
        } else if (msg.includes('api key') || msg.includes('gemini')) {
          errorMessage = 'AI Service Error: The Gemini API configuration is missing or invalid.';
          suggestion = 'Please contact the administrator to configure the API key properly.';
        } else if (msg.includes('forms') || msg.includes('create')) {
          errorMessage = 'Google Forms Error: Unable to create the quiz form.';
          suggestion = 'This may be a temporary Google Services issue. Please try again in a few minutes.';
        } else if (msg.includes('network') || msg.includes('timeout')) {
          errorMessage = 'Network Error: Unable to connect to required services.';
          suggestion = 'Check your internet connection and try again.';
        } else {
          errorMessage = error.message;
        }
      } else {
        errorMessage = 'An unexpected error occurred during quiz generation.';
        suggestion = 'Please try refreshing the page and attempting again.';
      }

      document.getElementById('errorMessage').innerHTML =
        `<strong>${errorMessage}</strong><br><br><em>${suggestion}</em>`;

      console.error('Quiz generation error:', error);

      // If it's a permission error, suggest checking permissions
      if (errorMessage.includes('Permission Error')) {
        setTimeout(() => {
          if (confirm('Would you like to check your permissions now?')) {
            initializeQuizGenerator();
          }
        }, 2000);
      }
    }

    // Show error message
    function showError(message) {
      document.getElementById('statusSection').style.display = 'block';
      document.getElementById('loadingStatus').style.display = 'none';
      document.getElementById('successStatus').style.display = 'none';
      document.getElementById('errorStatus').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    // Test minimal form creation (no quiz features)
    function testMinimalForm() {
      if (isGenerating) return;

      console.log('üî¨ Starting minimal form test (basic questions only)...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing basic form creation without quiz features...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Minimal test result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: { coding: 1, multipleChoice: 1, total: 2 },
              unit: 'Minimal Test (No Quiz Features)',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Minimal test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testMinimalFormCreation();
    }

    // Test incremental quiz features
    function testIncrementalFeatures() {
      if (isGenerating) return;

      console.log('üìà Starting incremental quiz features test...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing quiz features step by step...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Incremental test result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: { coding: 0, multipleChoice: 1, total: 1 },
              unit: 'Incremental Quiz Features Test',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Incremental test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testIncrementalQuizFeatures();
    }

    // Test simplified quiz creation (bypassing complex forms service)
    function testSimplifiedQuiz() {
      if (isGenerating) return;

      console.log('‚ö° Starting simplified quiz creation test...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Creating quiz with proven working approach...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Simplified quiz result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: { coding: 2, multipleChoice: 2, total: 4 },
              unit: 'Simplified Working Approach',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Simplified test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testSimplifiedQuizCreation();
    }

    // Test just basic FormApp.create
    function testJustForm() {
      if (isGenerating) return;

      console.log('‚ö° Testing just basic FormApp operations...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing basic FormApp.create only...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Just form test result:', result);
          if (result.success) {
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('successStatus').style.display = 'block';
            document.getElementById('successMessage').textContent = 'Basic FormApp operations work! Form created successfully.';
            isGenerating = false;
          } else {
            handleGenerationError(result.error || 'Basic form test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testJustFormCreation();
    }

    // Test ultra basic operations
    function testUltraBasic() {
      if (isGenerating) return;

      console.log('üî¨ Testing ultra basic operations...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing ultra basic forms service operations...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Ultra basic test result:', result);
          if (result.success) {
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('successStatus').style.display = 'block';
            document.getElementById('successMessage').textContent = `Ultra basic operations work! Completed step ${result.step}.`;
            isGenerating = false;
          } else {
            handleGenerationError(`Ultra basic test failed at step ${result.step}: ${result.error}`);
          }
        })
        .withFailureHandler(handleGenerationError)
        .testUltraBasicOperations();
    }

    // Test forms service with simple data structure
    function testFormsServiceSimple() {
      if (isGenerating) return;

      console.log('üîß Testing forms service with simple data...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing forms service with known good data structure...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Forms service simple data test result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: { coding: 1, multipleChoice: 1, total: 2 },
              unit: 'Forms Service with Simple Data',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Forms service simple data test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testFormsServiceWithSimpleData();
    }

    // Test forms service components individually for diagnosis
    function testDiagnostic() {
      if (isGenerating) return;

      console.log('üîç Starting diagnostic test of forms service components...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing each forms service component individually...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Diagnostic test result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: { coding: 1, multipleChoice: 1, total: 2 },
              unit: 'Forms Service Diagnostic (All Components)',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Diagnostic test failed');
          }
        })
        .withFailureHandler(handleGenerationError)
        .testFormsServiceComponents();
    }

    // Test hardcoded quiz generation
    function testHardcodedQuiz() {
      if (isGenerating) return;

      console.log('üß™ Starting hardcoded quiz test...');
      isGenerating = true;
      showLoadingStatus();

      // Update progress text for test
      document.getElementById('progressText').textContent = 'Testing Forms API with sample questions...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Test result:', result);
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: result.formResult,
              questions: {
                coding: 2,
                multipleChoice: 3,
                total: 5
              },
              unit: 'Sample Test Data',
              generatedAt: new Date().toISOString(),
              warnings: []
            });
          } else {
            handleGenerationError(result.error || 'Test failed');
          }
        })
        .withFailureHandler(function (error) {
          console.error('Test failed:', error);
          handleGenerationError(error);
        })
        .testHardcodedQuizGeneration();
    }

    // Method-specific test functions
    function testQuizMethods() {
      if (isGenerating) return;

      console.log('üéØ Testing quiz configuration methods...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing quiz configuration methods (setIsQuiz, setShuffleQuestions, etc.)...';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: 'Quiz Config Methods Test Completed' },
              questions: { total: 'All methods tested' },
              unit: 'Quiz Configuration Test',
              generatedAt: new Date().toISOString(),
              methodResults: result.methods
            });
          } else {
            handleGenerationError('Quiz config method failed: ' + (result.failedMethod || 'Unknown') + ' - ' + (result.error || 'See console'));
          }
        })
        .withFailureHandler(function (error) {
          console.error('Quiz methods test failed:', error);
          handleGenerationError('Quiz methods test failed: ' + error);
        })
        .testQuizConfigurationMethods();
    }

    function testFeedbackMethods() {
      if (isGenerating) return;

      console.log('üí¨ Testing feedback system methods...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing feedback system methods (createFeedback, setFeedbackForCorrect, etc.)...';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: 'Feedback Methods Test Completed' },
              questions: { total: 'All methods tested' },
              unit: 'Feedback System Test',
              generatedAt: new Date().toISOString(),
              methodResults: result.methods
            });
          } else {
            handleGenerationError('Feedback method failed: ' + (result.failedMethod || 'Unknown') + ' - ' + (result.error || 'See console'));
          }
        })
        .withFailureHandler(function (error) {
          console.error('Feedback methods test failed:', error);
          handleGenerationError('Feedback methods test failed: ' + error);
        })
        .testFeedbackSystemMethods();
    }

    function testPointsMethods() {
      if (isGenerating) return;

      console.log('üèÜ Testing points assignment methods...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing points assignment methods (setPoints on various question types)...';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: 'Points Methods Test Completed' },
              questions: { total: 'All methods tested' },
              unit: 'Points Assignment Test',
              generatedAt: new Date().toISOString(),
              methodResults: result.methods
            });
          } else {
            handleGenerationError('Points method failed: ' + (result.failedMethod || 'Unknown') + ' - ' + (result.error || 'See console'));
          }
        })
        .withFailureHandler(function (error) {
          console.error('Points methods test failed:', error);
          handleGenerationError('Points methods test failed: ' + error);
        })
        .testPointsAssignmentMethods();
    }

    function testSectionMethods() {
      if (isGenerating) return;

      console.log('üìã Testing section header methods...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing section header methods (addSectionHeaderItem, setTitle, setHelpText)...';

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: 'Section Methods Test Completed' },
              questions: { total: 'All methods tested' },
              unit: 'Section Header Test',
              generatedAt: new Date().toISOString(),
              methodResults: result.methods
            });
          } else {
            handleGenerationError('Section method failed: ' + (result.failedMethod || 'Unknown') + ' - ' + (result.error || 'See console'));
          }
        })
        .withFailureHandler(function (error) {
          console.error('Section methods test failed:', error);
          handleGenerationError('Section methods test failed: ' + error);
        })
        .testSectionHeaderMethods();
    }

    function testAllMethods() {
      if (isGenerating) return;

      console.log('üîç Running MASTER METHOD TEST - testing all Forms API methods...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Running comprehensive Forms API method isolation test...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('Master method test result:', result);

          if (result.overallSuccess) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: '‚úÖ ALL METHODS PASSED - Issue is in complex interaction' },
              questions: { total: 'All individual methods work' },
              unit: 'Master Method Test',
              generatedAt: new Date().toISOString(),
              allResults: result.tests
            });
          } else {
            const failure = result.firstFailure;
            handleGenerationError(`üéØ EXACT FAILURE IDENTIFIED: ${failure.category}.${failure.method} failed with: ${failure.error}`);
          }
        })
        .withFailureHandler(function (error) {
          console.error('Master method test failed:', error);
          handleGenerationError('Master method test failed: ' + error);
        })
        .testAllFormsMethods();
    }

    // Test setRequireLogin() method isolation
    function testRequireLoginIsolated() {
      if (isGenerating) return;

      console.log('üîê Testing setRequireLogin() method in isolation...');
      isGenerating = true;
      showLoadingStatus();

      document.getElementById('progressText').textContent = 'Testing setRequireLogin() under different conditions...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('setRequireLogin test result:', result);

          if (result.overallSuccess) {
            handleGenerationSuccess({
              success: true,
              form: { publishedUrl: `‚úÖ setRequireLogin() WORKS! Working approach: ${result.workingApproach}` },
              questions: { total: `${result.summary.successful}/${result.summary.total} tests passed` },
              unit: 'setRequireLogin() Investigation',
              generatedAt: new Date().toISOString(),
              testResults: result
            });
          } else {
            const failedTests = result.summary.failedTests.join(', ');
            handleGenerationError(`‚ùå setRequireLogin() failed in all ${result.summary.total} test conditions. Failed tests: ${failedTests}. See console for details.`);
          }
        })
        .withFailureHandler(function (error) {
          console.error('setRequireLogin test failed:', error);
          handleGenerationError('setRequireLogin test failed: ' + error);
        })
        .testSetRequireLoginIsolated();
    }

    // Reset form to initial state
    function resetForm() {
      isGenerating = false;
      document.getElementById('statusSection').style.display = 'none';
      document.getElementById('generateBtn').disabled = document.getElementById('unitSelect').value === '';

      // Reset progress
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressText').textContent = 'Initializing AI question generation...';

      // Recheck permissions when resetting after an error
      if (permissionStatus && !permissionStatus.ready) {
        setTimeout(initializeQuizGenerator, 500);
      }
    }

    // Enhanced retry function with permission check
    function retryWithPermissionCheck() {
      // First check if we still have all permissions
      google.script.run
        .withSuccessHandler(function (status) {
          if (status.ready) {
            // Permissions are good, just retry the quiz generation
            resetForm();
            setTimeout(() => {
              if (document.getElementById('unitSelect').value) {
                generateQuiz();
              }
            }, 1000);
          } else {
            // Permissions are missing, restart initialization
            resetForm();
            initializeQuizGenerator();
          }
        })
        .withFailureHandler(function (error) {
          console.error('Permission recheck failed:', error);
          resetForm();
        })
        .getPermissionStatus();
    }

    // Global error handler for unexpected errors
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      console.error('Global error:', { msg, url, lineNo, columnNo, error });

      if (isGenerating) {
        handleGenerationError({
          message: 'An unexpected JavaScript error occurred: ' + msg,
          details: `Line ${lineNo}: ${error}`
        });
      }

      return false; // Don't suppress default error handling
    };
  </script>
</body>

</html>