<script>
// Classroom Snapshot Exporter JavaScript

// Global state
let currentSnapshotData = null;
let exportInProgress = false;

// DOM elements
const elements = {
    statusCard: () => document.getElementById('statusCard'),
    statusContent: () => document.getElementById('statusContent'),
    classroomList: () => document.getElementById('classroomList'),
    progressSection: () => document.getElementById('progressSection'),
    progressFill: () => document.getElementById('progressFill'),
    progressDetails: () => document.getElementById('progressDetails'),
    resultsSection: () => document.getElementById('resultsSection'),
    resultsTitle: () => document.getElementById('resultsTitle'),
    resultsContent: () => document.getElementById('resultsContent'),
    resultsActions: () => document.getElementById('resultsActions'),
    previewModal: () => document.getElementById('previewModal'),
    previewContent: () => document.getElementById('previewContent'),
    exportBtn: () => document.getElementById('exportBtn'),
    toastContainer: () => document.getElementById('toastContainer')
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    console.log('Classroom Snapshot Exporter initialized');
    
    // Check connection on load
    setTimeout(checkConnection, 500);
    
    // Set up event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    exportData();
                    break;
                case 't':
                    e.preventDefault();
                    runTest();
                    break;
                case 'r':
                    e.preventDefault();
                    checkConnection();
                    break;
            }
        }
        
        // ESC to close modal
        if (e.key === 'Escape') {
            closePreview();
        }
    });
    
    // Click outside modal to close
    elements.previewModal()?.addEventListener('click', function(e) {
        if (e.target === this) {
            closePreview();
        }
    });
}

// Connection and Status Functions
function checkConnection() {
    console.log('Checking Google Classroom connection...');
    updateStatus('info', 'Checking Google Classroom connection...', true);
    
    google.script.run
        .withSuccessHandler(handleConnectionResult)
        .withFailureHandler(handleConnectionError)
        .checkPermissions();
}

function handleConnectionResult(result) {
    console.log('Connection check result:', result);
    
    if (result.success) {
        updateStatus('success', `
            <strong>✓ Connected to Google Classroom</strong><br>
            <small>API access verified • Loading your classrooms...</small>
        `);
        showToast('Connection successful! Loading classrooms...', 'success');
        
        // Auto-load classrooms after successful connection
        setTimeout(() => {
            loadClassrooms();
        }, 1000);
        
    } else {
        updateStatus('error', `
            <strong>✗ Connection Failed</strong><br>
            <small>${result.error}</small>
        `);
        showToast('Connection failed: ' + result.error, 'error');
    }
}

function handleConnectionError(error) {
    console.error('Connection check error:', error);
    updateStatus('error', `
        <strong>✗ Connection Error</strong><br>
        <small>Failed to check API access: ${error.message}</small>
    `);
    showToast('Connection error: ' + error.message, 'error');
}

function updateStatus(type, message, loading = false) {
    const statusContent = elements.statusContent();
    if (!statusContent) return;
    
    statusContent.className = `status-content ${type}`;
    statusContent.innerHTML = message;
    
    if (loading) {
        statusContent.classList.add('loading');
    } else {
        statusContent.classList.remove('loading');
    }
}

// Classroom Loading Functions
function loadClassrooms() {
    console.log('Loading classrooms...');
    
    // Update load button to show loading state
    const loadBtn = document.querySelector('button[onclick="loadClassrooms()"]');
    if (loadBtn) {
        loadBtn.disabled = true;
        loadBtn.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            Loading Classrooms...
        `;
        loadBtn.classList.add('loading');
    }
    
    updateStatus('info', `
        <strong>Loading Classrooms...</strong><br>
        <small>Fetching your Google Classroom data...</small>
    `, true);
    
    showToast('Loading classrooms...', 'info');
    
    google.script.run
        .withSuccessHandler(handleClassroomsLoadedComplete)
        .withFailureHandler(handleClassroomsErrorComplete)
        .getClassroomList();
}

function handleClassroomsLoadedComplete(result) {
    // Reset load button
    const loadBtn = document.querySelector('button[onclick="loadClassrooms()"]');
    if (loadBtn) {
        loadBtn.disabled = false;
        loadBtn.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            Reload Classrooms
        `;
        loadBtn.classList.remove('loading');
    }
    
    handleClassroomsLoaded(result);
}

function handleClassroomsErrorComplete(error) {
    // Reset load button
    const loadBtn = document.querySelector('button[onclick="loadClassrooms()"]');
    if (loadBtn) {
        loadBtn.disabled = false;
        loadBtn.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            Retry Load Classrooms
        `;
        loadBtn.classList.remove('loading');
    }
    
    handleClassroomsError(error);
}

function handleClassroomsLoaded(result) {
    console.log('Classrooms loaded:', result);
    
    if (result.success && result.classrooms && Array.isArray(result.classrooms) && result.classrooms.length > 0) {
        displayClassrooms(result.classrooms);
        enableExportButtons();
        updateStatus('success', `
            <strong>✓ Ready to Export</strong><br>
            <small>${result.classrooms.length} classrooms loaded • ${document.querySelectorAll('#classroomList input[type="checkbox"]:checked').length} selected for export</small>
        `);
        showToast(`Loaded ${result.classrooms.length} classrooms`, 'success');
    } else if (result.success) {
        showToast('No classrooms found', 'warning');
        const classroomList = elements.classroomList();
        if (classroomList) classroomList.style.display = 'none';
        updateStatus('warning', `
            <strong>⚠ No Classrooms Found</strong><br>
            <small>No active classrooms found in your Google Classroom account</small>
        `);
    } else {
        showToast('Failed to load classrooms: ' + (result.error || 'Unknown error'), 'error');
        updateStatus('error', `
            <strong>✗ Failed to Load Classrooms</strong><br>
            <small>${result.error || 'Unknown error'}</small>
        `);
    }
}

function handleClassroomsError(error) {
    console.error('Error loading classrooms:', error);
    const errorMessage = error && error.message ? error.message : 'Unknown error';
    showToast('Error loading classrooms: ' + errorMessage, 'error');
}

function displayClassrooms(classrooms) {
    const classroomList = elements.classroomList();
    const classroomControls = document.getElementById('classroomControls');
    
    if (!classroomList || !Array.isArray(classrooms)) return;
    
    classroomList.innerHTML = classrooms.map((classroom, index) => {
        if (!classroom || !classroom.id) return '';
        
        const name = classroom.name || 'Unnamed Classroom';
        const section = classroom.section ? escapeHtml(classroom.section) + ' • ' : '';
        const studentCount = classroom.studentCount || 0;
        
        // Format last activity date
        const lastActivity = formatLastActivity(classroom.updateTime || classroom.creationTime);
        
        // Only check first 3 classrooms by default (most recent)
        const isChecked = classroom.isRecent || index < 3;
        const recentBadge = classroom.isRecent ? '<span class="recent-badge">Recent</span>' : '';
        const itemClass = classroom.isRecent ? 'classroom-item recent' : 'classroom-item';
        
        return `
            <div class="${itemClass}">
                <input type="checkbox" id="classroom-${classroom.id}" value="${classroom.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectionCount()">
                <div class="classroom-info">
                    <h5>${escapeHtml(name)} ${recentBadge}</h5>
                    <small>${section}${studentCount} students • Last activity: ${lastActivity}</small>
                </div>
            </div>
        `;
    }).filter(html => html !== '').join('');
    
    classroomList.style.display = 'block';
    if (classroomControls) classroomControls.style.display = 'block';
    
    // Update selection count after displaying
    setTimeout(updateSelectionCount, 100);
}

function formatLastActivity(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
        return `${Math.floor(diffDays / 365)} years ago`;
    } catch (error) {
        return dateString.split('T')[0]; // Fallback to date part
    }
}

// Export Functions
function runTest() {
    if (exportInProgress) {
        showToast('Export already in progress', 'warning');
        return;
    }
    
    console.log('Running test export...');
    exportInProgress = true;
    
    showProgressSection();
    updateProgress(10, 'Starting test export...');
    
    google.script.run
        .withSuccessHandler(handleTestResult)
        .withFailureHandler(handleExportError)
        .testExport();
}

function exportData() {
    if (exportInProgress) {
        showToast('Export already in progress', 'warning');
        return;
    }
    
    console.log('Starting full export...');
    exportInProgress = true;
    
    // Get export options
    const options = getExportOptions();
    console.log('Export options:', options);
    
    showProgressSection();
    updateProgress(5, 'Initializing export...');
    
    google.script.run
        .withSuccessHandler(handleExportResult)
        .withFailureHandler(handleExportError)
        .exportClassroomSnapshot(options);
}

function getExportOptions() {
    const includeSubmissions = document.getElementById('includeSubmissions')?.checked || false;
    const includeMaterials = document.getElementById('includeMaterials')?.checked || false;
    const includeQuizData = document.getElementById('includeQuizData')?.checked || false;
    
    // Get selected classrooms
    const checkboxes = document.querySelectorAll('#classroomList input[type="checkbox"]:checked');
    const selectedClassrooms = checkboxes ? Array.from(checkboxes)
        .filter(cb => cb && cb.value)
        .map(cb => cb.value) : [];
    
    return {
        includeSubmissions,
        includeMaterials,
        includeQuizData,
        selectedClassrooms: selectedClassrooms.length > 0 ? selectedClassrooms : null
    };
}

function handleTestResult(result) {
    console.log('Test export result:', result);
    exportInProgress = false;
    
    if (result.success) {
        updateProgress(100, 'Test export completed successfully!');
        setTimeout(() => {
            hideProgressSection();
            showResults('Test Export Successful', result, true);
        }, 1000);
        showToast('Test export completed!', 'success');
    } else {
        updateProgress(0, 'Test export failed');
        setTimeout(hideProgressSection, 2000);
        showToast('Test export failed: ' + result.error, 'error');
    }
}

function handleExportResult(result) {
    console.log('Full export result:', result);
    exportInProgress = false;
    
    if (result.success) {
        currentSnapshotData = result.data;
        updateProgress(100, 'Export completed successfully!');
        setTimeout(() => {
            hideProgressSection();
            showResults('Export Completed', result, false);
        }, 1000);
        showToast('Export completed successfully!', 'success');
    } else {
        updateProgress(0, 'Export failed');
        setTimeout(hideProgressSection, 2000);
        showToast('Export failed: ' + result.error, 'error');
    }
}

function handleExportError(error) {
    console.error('Export error:', error);
    exportInProgress = false;
    
    updateProgress(0, 'Export failed');
    setTimeout(hideProgressSection, 2000);
    const errorMessage = error && error.message ? error.message : 'Unknown error';
    showToast('Export error: ' + errorMessage, 'error');
}

// Progress Functions
function showProgressSection() {
    const progressSection = elements.progressSection();
    const resultsSection = elements.resultsSection();
    
    if (progressSection) progressSection.style.display = 'block';
    if (resultsSection) resultsSection.style.display = 'none';
    
    // Scroll to progress section
    if (progressSection) progressSection.scrollIntoView({ behavior: 'smooth' });
}

function hideProgressSection() {
    const progressSection = elements.progressSection();
    if (progressSection) progressSection.style.display = 'none';
}

function updateProgress(percentage, message) {
    const progressFill = elements.progressFill();
    const progressDetails = elements.progressDetails();
    
    if (progressFill) progressFill.style.width = percentage + '%';
    if (progressDetails) progressDetails.innerHTML = `<p>${message}</p>`;
}

// Results Functions
function showResults(title, result, isTest) {
    const resultsTitle = elements.resultsTitle();
    const resultsSection = elements.resultsSection();
    
    if (resultsTitle) resultsTitle.textContent = title;
    if (resultsSection) resultsSection.style.display = 'block';
    
    let content = '';
    
    if (result.success && result.data) {
        const stats = result.data.globalStats || {};
        
        content = `
            <div class="results-summary">
                <h4>Export Summary</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalClassrooms || 0}</span>
                        <span class="stat-label">Classrooms</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalStudents || 0}</span>
                        <span class="stat-label">Students</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalAssignments || 0}</span>
                        <span class="stat-label">Assignments</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalSubmissions || 0}</span>
                        <span class="stat-label">Submissions</span>
                    </div>
                    ${stats.ungradedSubmissions !== undefined ? `
                    <div class="stat-item">
                        <span class="stat-number">${stats.ungradedSubmissions}</span>
                        <span class="stat-label">Ungraded</span>
                    </div>
                    ` : ''}
                    ${stats.averageGrade !== undefined && stats.averageGrade !== null ? `
                    <div class="stat-item">
                        <span class="stat-number">${stats.averageGrade.toFixed(1)}%</span>
                        <span class="stat-label">Avg Grade</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        if (!isTest) {
            content += `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p><strong>✓ Data Ready for Import</strong></p>
                    <p><small>Your classroom snapshot is ready to import into the Roo platform. 
                    Download the file and use the "Import Snapshot" feature in your Roo teacher dashboard.</small></p>
                </div>
            `;
        }
    } else if (result.success && isTest) {
        content = `
            <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                <p><strong>✓ Export System Working</strong></p>
                <p>The export functionality is working correctly. ${result.message || ''}</p>
                ${result.sampleData ? `
                <p><small>Sample data: ${result.sampleData.classroomCount} classroom(s), 
                ${result.sampleData.studentCount} student(s), ${result.sampleData.assignmentCount} assignment(s)</small></p>
                ` : ''}
            </div>
        `;
    } else {
        content = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                <p><strong>✗ Export Failed</strong></p>
                <p>${result.error || 'Unknown error occurred'}</p>
                ${result.details ? `<p><small>${result.details}</small></p>` : ''}
            </div>
        `;
    }
    
    const resultsContent = elements.resultsContent();
    const resultsActions = elements.resultsActions();
    
    if (resultsContent) resultsContent.innerHTML = content;
    if (resultsActions) resultsActions.style.display = result.success && !isTest ? 'flex' : 'none';
    
    // Scroll to results
    if (resultsSection) resultsSection.scrollIntoView({ behavior: 'smooth' });
}

// Download and Preview Functions
function downloadSnapshot() {
    if (!currentSnapshotData) {
        showToast('No snapshot data available', 'error');
        return;
    }
    
    try {
        const jsonString = JSON.stringify(currentSnapshotData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        const teacherEmail = currentSnapshotData.teacher?.email || 'teacher';
        const timestamp = new Date().toISOString().split('T')[0];
        const emailPrefix = teacherEmail.includes('@') ? teacherEmail.split('@')[0] : teacherEmail;
        const filename = `classroom-snapshot-${emailPrefix}-${timestamp}.json`;
        
        // Create download link
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Snapshot downloaded successfully!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showToast('Failed to download snapshot', 'error');
    }
}

function previewSnapshot() {
    if (!currentSnapshotData) {
        showToast('No snapshot data available', 'error');
        return;
    }
    
    try {
        const jsonString = JSON.stringify(currentSnapshotData, null, 2);
        elements.previewContent().textContent = jsonString;
        elements.previewModal().style.display = 'flex';
    } catch (error) {
        console.error('Preview error:', error);
        showToast('Failed to preview snapshot', 'error');
    }
}

function closePreview() {
    elements.previewModal().style.display = 'none';
}

function copyToClipboard() {
    if (!currentSnapshotData) {
        showToast('No snapshot data available', 'error');
        return;
    }
    
    try {
        const jsonString = JSON.stringify(currentSnapshotData, null, 2);
        navigator.clipboard.writeText(jsonString).then(() => {
            showToast('Snapshot copied to clipboard!', 'success');
        }).catch(error => {
            console.error('Clipboard error:', error);
            showToast('Failed to copy to clipboard', 'error');
        });
    } catch (error) {
        console.error('Copy error:', error);
        showToast('Failed to copy snapshot', 'error');
    }
}

// Utility Functions
function showToast(message, type = 'info', duration = 4000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    elements.toastContainer().appendChild(toast);
    
    // Auto-remove toast
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, duration);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Simulate progress for user feedback
function simulateProgress(callback) {
    let progress = 0;
    const steps = [
        { progress: 10, message: 'Connecting to Google Classroom...' },
        { progress: 25, message: 'Loading classroom information...' },
        { progress: 40, message: 'Fetching assignments...' },
        { progress: 60, message: 'Collecting student data...' },
        { progress: 80, message: 'Processing submissions...' },
        { progress: 95, message: 'Finalizing export...' }
    ];
    
    let stepIndex = 0;
    
    const interval = setInterval(() => {
        if (stepIndex < steps.length) {
            const step = steps[stepIndex];
            updateProgress(step.progress, step.message);
            stepIndex++;
        } else {
            clearInterval(interval);
            if (callback) callback();
        }
    }, 1000);
}

// Classroom Selection Functions
function selectRecentClassrooms() {
    const checkboxes = document.querySelectorAll('#classroomList input[type="checkbox"]');
    checkboxes.forEach((cb, index) => {
        cb.checked = index < 3; // Check first 3 (most recent)
    });
    updateSelectionCount();
    showToast('Selected 3 most recent classrooms', 'info');
}

function selectAllClassrooms() {
    const checkboxes = document.querySelectorAll('#classroomList input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectionCount();
    showToast('Selected all classrooms', 'info');
}

function selectNoClassrooms() {
    const checkboxes = document.querySelectorAll('#classroomList input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectionCount();
    showToast('Deselected all classrooms', 'info');
}

function updateSelectionCount() {
    const checkboxes = document.querySelectorAll('#classroomList input[type="checkbox"]:checked');
    const count = checkboxes.length;
    const selectionCount = document.getElementById('selectionCount');
    
    if (selectionCount) {
        const plural = count === 1 ? 'classroom' : 'classrooms';
        selectionCount.textContent = `${count} ${plural} selected for export`;
        
        // Visual feedback for selection
        if (count === 0) {
            selectionCount.style.color = '#dc3545'; // Red
            disableExportButtons(); // Disable if no classrooms selected
        } else if (count <= 3) {
            selectionCount.style.color = '#28a745'; // Green
            enableExportButtons();
        } else {
            selectionCount.style.color = '#ffc107'; // Orange/Yellow
            enableExportButtons();
        }
    }
    
    // Update status with current selection
    updateStatus('success', `
        <strong>✓ Ready to Export</strong><br>
        <small>${document.querySelectorAll('#classroomList .classroom-item').length} classrooms loaded • ${count} selected for export</small>
    `);
}

// Button control functions
function enableExportButtons() {
    const testBtn = document.getElementById('testBtn');
    const exportBtn = document.getElementById('exportBtn');
    const disabledMessage = document.getElementById('disabledMessage');
    const enabledMessages = document.getElementById('enabledMessages');
    
    if (testBtn) testBtn.disabled = false;
    if (exportBtn) exportBtn.disabled = false;
    
    // Show enabled messages, hide disabled message
    if (disabledMessage) disabledMessage.style.display = 'none';
    if (enabledMessages) enabledMessages.style.display = 'block';
}

function disableExportButtons() {
    const testBtn = document.getElementById('testBtn');
    const exportBtn = document.getElementById('exportBtn');
    const disabledMessage = document.getElementById('disabledMessage');
    const enabledMessages = document.getElementById('enabledMessages');
    
    if (testBtn) testBtn.disabled = true;
    if (exportBtn) exportBtn.disabled = true;
    
    // Show disabled message, hide enabled messages
    if (disabledMessage) disabledMessage.style.display = 'block';
    if (enabledMessages) enabledMessages.style.display = 'none';
}

// Export functions for global access
window.checkConnection = checkConnection;
window.loadClassrooms = loadClassrooms;
window.runTest = runTest;
window.exportData = exportData;
window.downloadSnapshot = downloadSnapshot;
window.previewSnapshot = previewSnapshot;
window.copyToClipboard = copyToClipboard;
window.closePreview = closePreview;
window.selectRecentClassrooms = selectRecentClassrooms;
window.selectAllClassrooms = selectAllClassrooms;
window.selectNoClassrooms = selectNoClassrooms;
window.updateSelectionCount = updateSelectionCount;

console.log('Classroom Snapshot Exporter JavaScript loaded');
</script>